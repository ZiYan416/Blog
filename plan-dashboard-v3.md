# Dashboard v3 重构计划 - 数据驱动的管理中枢

## 📋 重构背景

当前 Dashboard 已完成基础架构（权限分离、路由优化），但功能相对简陋：
- ✅ 已完成：权限熔断、基础数据展示、快捷操作入口
- ❌ 待完善：可视化报表功能、用户管理系统、动态数据洞察

**重构目标**：将 Dashboard 从"静态数据面板"升级为"智能管理中枢"，提供数据可视化分析和完整的用户管理能力。

---

## 🎨 设计理念

### 视觉风格延续
保持与 Profile 页面一致的**极简现代主义**设计语言：
- **圆角系统**: 统一使用 `rounded-3xl` 大圆角卡片
- **配色方案**:
  - 浅色模式: `bg-[#fafafa]` 背景 + `bg-white` 卡片
  - 深色模式: `bg-[#050505]` 背景 + `bg-neutral-900` 卡片
- **层次构建**:
  - 边框: `border-black/[0.03]` (浅色) / `border-white/[0.03]` (深色)
  - 阴影: `shadow-sm` 柔和阴影
  - 悬停: `hover:border-black/10` 微妙交互反馈
- **图标系统**: Lucide Icons + 彩色图标底色 (如 `bg-blue-500/10`)
- **间距节奏**:
  - 移动端: `gap-3 p-4`
  - 桌面端: `gap-6 p-6`

### 交互原则
- **响应式优先**: 移动端 2 列网格，桌面端 4 列网格
- **渐进式加载**: 骨架屏 + 数据懒加载
- **实时反馈**: Live 标签 + 动画过渡

---

## 🏗️ 页面架构设计

### 整体布局 (Grid Layout)

```
┌─────────────────────────────────────────────────────────────┐
│  Dashboard Header (欢迎区 + 快捷操作按钮)                      │
├─────────────────────────────────────────────────────────────┤
│  核心数据指标 (4 Grid Cards)                                  │
│  [总文章] [总阅读] [总评论] [注册用户]                         │
├─────────────────────────────────────────────────────────────┤
│  可视化报表区 (Tabs 切换)                                      │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ [数据总览] [内容分析] [用户增长] [互动分析]               │ │
│  ├─────────────────────────────────────────────────────────┤ │
│  │  动态图表区域 (折线图/柱状图/饼图)                         │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  双栏布局 (2/3 Main + 1/3 Sidebar)                            │
│  ┌──────────────────────────┬────────────────────────────┐   │
│  │ 用户管理 (Table)          │  系统快捷操作               │   │
│  │ - 用户列表               │  - 管理员卡片               │   │
│  │ - 权限管理               │  - 待办事项                 │   │
│  │ - 批量操作               │  - 写作助手                 │   │
│  └──────────────────────────┴────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 功能模块详细设计

### 1️⃣ 核心数据指标区 (已有，需优化)

**现状**: 4 个静态卡片展示基础统计
**优化方向**:
- ✨ 添加**趋势指示器**: 显示相比上周/上月的增长百分比
  ```tsx
  <div className="flex items-center gap-1 text-xs">
    <TrendingUp className="w-3 h-3 text-green-500" />
    <span className="text-green-500">+12%</span>
  </div>
  ```
- ✨ 添加**迷你图表**: 每个卡片底部显示 7 天数据的 Sparkline (迷你折线图)
- ✨ **点击跳转**: 卡片可点击，跳转到对应的详细报表标签页

**数据来源**:
- 需要新增 `stats_history` 表记录每日统计快照
- 或实时计算过去 7 天的数据

---

### 2️⃣ 可视化报表区 (全新功能) ⭐

**组件路径**: `src/components/dashboard/analytics-tabs.tsx`

#### 标签页结构

##### Tab 1: 数据总览 (Overview)
展示全站数据的综合视图：
- **时间范围选择器**: [7天] [30天] [90天] [自定义]
- **多维度对比图表**:
  - 折线图: 文章发布量 vs 阅读量 vs 评论数 (三条线)
  - 使用库: `recharts` 或 `tremor`
- **关键指标卡片**:
  - 平均每篇阅读量
  - 评论互动率 (评论数 / 阅读量)
  - 用户活跃度 (日活 / 总用户)

##### Tab 2: 内容分析 (Content Analytics)
聚焦文章和标签的数据：
- **标签分布饼图**: 显示各标签下的文章数量占比
- **文章表现排行**:
  - 热门文章 Top 10 (阅读量)
  - 互动最多 Top 10 (评论数)
  - 增长最快 Top 10 (近 7 天阅读增量)
- **发布日历热力图**: 类似 GitHub Contributions，展示每天的发布活跃度

##### Tab 3: 用户增长 (User Growth)
用户相关数据分析：
- **用户增长曲线**: 累计注册用户随时间的增长折线图
- **新增用户柱状图**: 每日/每周新注册用户数
- **用户来源分析**: (如果有 UTM 追踪) 显示用户来源渠道
- **活跃用户统计**:
  - DAU (日活跃用户)
  - MAU (月活跃用户)
  - 最近 7 天评论最多的用户 Top 5

##### Tab 4: 互动分析 (Engagement Analytics)
评论和互动数据：
- **评论趋势图**: 每日评论数折线图
- **平均响应时间**: 管理员回复评论的平均时长
- **活跃时段热力图**: 显示用户在哪些时段最活跃 (24小时 x 7天)
- **高频评论者**: 显示评论数最多的用户及其头像

**技术选型**:
- 图表库: **Recharts** (轻量、适配 shadcn/ui 风格)
  ```bash
  npm install recharts
  ```
- 备选: **Tremor** (专为 Dashboard 设计的图表库)

**数据准备**:
- 新增 API 路由: `/api/admin/analytics`
- 查询逻辑:
  ```sql
  -- 示例：获取过去 30 天的每日文章发布量
  SELECT DATE(created_at) as date, COUNT(*) as count
  FROM posts
  WHERE created_at >= NOW() - INTERVAL '30 days'
  GROUP BY DATE(created_at)
  ORDER BY date
  ```

---

### 3️⃣ 用户管理系统 (全新功能) ⭐

**组件路径**: `src/components/dashboard/user-management.tsx`

#### 功能清单

##### A. 用户列表表格
使用 **shadcn/ui Data Table** 组件：
- **显示字段**:
  - 头像 + 昵称
  - 邮箱
  - 角色标签 (普通用户 / 管理员)
  - 加入日期
  - 最后活跃时间
  - 评论数
  - 操作按钮
- **交互功能**:
  - 搜索: 按昵称或邮箱过滤
  - 排序: 支持按加入日期、活跃时间排序
  - 分页: 每页 10/20/50 条可选
- **操作按钮**:
  - 🔧 编辑用户信息 (打开 Dialog)
  - 🛡️ 设置为管理员 / 取消管理员
  - 🚫 禁用账户 (软删除)
  - 🗑️ 删除用户 (硬删除，需二次确认)

##### B. 用户详情对话框
点击"编辑"按钮时弹出 `Dialog`：
- **可编辑字段**:
  - 昵称 (display_name)
  - 个性签名 (bio)
  - 头像 URL (avatar_url)
  - 管理员权限 (is_admin) - Switch 开关
- **只读信息**:
  - 注册邮箱
  - 注册时间
  - UID
- **底部操作**:
  - [保存更改] [取消]

##### C. 批量操作
- 选择多个用户 (Checkbox)
- 批量操作菜单:
  - 批量设置为管理员
  - 批量禁用
  - 批量导出数据 (CSV)

##### D. 快速统计卡片
在用户表格上方显示：
- 总用户数
- 管理员数量
- 本周新增用户
- 活跃用户占比

**权限保护**:
- 仅超级管理员可以修改其他管理员权限
- 不能删除自己
- 操作日志记录 (可选)

**数据 API**:
- `GET /api/admin/users` - 获取用户列表
- `PATCH /api/admin/users/:id` - 更新用户信息
- `DELETE /api/admin/users/:id` - 删除用户

---

### 4️⃣ 侧边栏优化 (已有，需调整)

**当前模块**:
- 管理员卡片
- 写作助手

**新增模块**:
- **待办事项卡片**:
  - 🔴 待审核评论 (数量红点提示)
  - 📝 草稿箱文章 (超过 7 天未发布的草稿)
  - ⚠️ 系统异常 (如存储空间不足)
- **最新动态**:
  - 最近 5 条评论的实时流
  - 新注册用户提醒

---

## 📦 组件结构

```
src/components/dashboard/
├── dashboard-header.tsx         (已有)
├── data-reports.tsx             (已有，需重构)
├── analytics-tabs.tsx           (新增 - 可视化报表主组件)
│   ├── overview-tab.tsx         (数据总览)
│   ├── content-analytics-tab.tsx(内容分析)
│   ├── user-growth-tab.tsx      (用户增长)
│   └── engagement-tab.tsx       (互动分析)
├── user-management.tsx          (新增 - 用户管理表格)
├── user-detail-dialog.tsx       (新增 - 用户编辑对话框)
├── stats-card.tsx               (新增 - 增强版统计卡片)
└── todo-alerts.tsx              (新增 - 待办事项卡片)
```

---

## 🗄️ 数据库设计

### 新增表 (可选，用于历史数据分析)

#### 1. `stats_snapshots` - 统计快照表
记录每日的全站统计数据，用于趋势图：
```sql
CREATE TABLE stats_snapshots (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  date DATE NOT NULL UNIQUE,
  total_posts INT DEFAULT 0,
  total_views INT DEFAULT 0,
  total_comments INT DEFAULT 0,
  total_users INT DEFAULT 0,
  new_users_today INT DEFAULT 0,
  active_users_today INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**生成方式**:
- 使用 Supabase Cron Jobs (PostgreSQL `pg_cron`)
- 或 Vercel Cron 每日 0 点触发 API 计算并插入

#### 2. `user_activity_logs` - 用户活动日志
记录用户的关键操作（可选）：
```sql
CREATE TABLE user_activity_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id),
  action_type TEXT, -- 'login', 'comment', 'like'
  metadata JSONB,   -- 额外数据
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 🛠️ 实施步骤

### 阶段 1: 基础设施准备 (1-2 天)
1. ✅ 安装图表库: `npm install recharts date-fns`
2. ✅ 创建 API 路由: `/api/admin/analytics`, `/api/admin/users`
3. ✅ 设计数据库表 (如需历史数据分析)
4. ✅ 创建新组件文件结构

### 阶段 2: 用户管理功能 (2-3 天)
1. ✅ 实现用户列表 Data Table
2. ✅ 开发用户编辑对话框
3. ✅ 集成权限管理 API
4. ✅ 添加批量操作功能
5. ✅ 测试权限边界

### 阶段 3: 可视化报表开发 (3-4 天)
1. ✅ 开发 `analytics-tabs.tsx` 主框架
2. ✅ 实现"数据总览"标签页 (折线图 + 关键指标)
3. ✅ 实现"内容分析"标签页 (饼图 + 排行榜)
4. ✅ 实现"用户增长"标签页 (增长曲线)
5. ✅ 实现"互动分析"标签页 (热力图)
6. ✅ 优化图表响应式布局

### 阶段 4: 数据统计优化 (1-2 天)
1. ✅ 升级核心数据指标卡片 (趋势 + 迷你图)
2. ✅ 替换"系统洞察"卡片为"标签分布"
3. ✅ 添加"待办事项"卡片

### 阶段 5: 性能与体验优化 (1-2 天)
1. ✅ 添加骨架屏加载状态
2. ✅ 实现图表数据懒加载
3. ✅ 优化移动端图表显示
4. ✅ 添加错误边界处理
5. ✅ 完善暗色模式适配

---

## 🎯 验收标准

### 功能完整性
- [ ] 用户管理：可查看、编辑、删除、授权用户
- [ ] 可视化报表：4 个标签页的图表全部正常显示
- [ ] 数据准确性：所有统计数字与数据库实际数据一致
- [ ] 权限控制：非管理员无法访问敏感操作

### 视觉一致性
- [ ] 所有卡片使用 `rounded-3xl` 圆角
- [ ] 颜色系统符合现有配色方案
- [ ] 移动端 2 列布局正常显示
- [ ] 暗色模式无样式异常

### 性能指标
- [ ] 首屏加载 < 2s
- [ ] 图表渲染 < 1s
- [ ] 用户列表分页加载 < 500ms

---

## 📚 技术栈确认

| 技术 | 用途 | 版本 |
|------|------|------|
| **Recharts** | 图表可视化 | ^2.15.0 |
| **shadcn/ui Data Table** | 用户管理表格 | latest |
| **date-fns** | 日期处理 | ^3.0.0 |
| **Supabase** | 数据查询 | 当前版本 |
| **Next.js Server Actions** | API 路由 | App Router |

---

## 🚀 启动建议

**优先级排序**:
1. 🥇 **用户管理功能** (基础管理能力，立即可用)
2. 🥈 **数据总览标签页** (核心可视化需求)
3. 🥉 **其他报表标签页** (逐步完善)

**开发顺序**:
建议先完成**用户管理**模块，因为它是管理后台的核心功能，且不依赖复杂的数据计算。然后再逐步开发可视化报表，可以按标签页顺序逐个实现。

---

## ✨ 未来扩展方向

- **实时数据推送**: 使用 Supabase Realtime 实现实时统计更新
- **导出功能**: 支持导出 PDF/Excel 格式的数据报表
- **权限细分**: 引入"编辑"、"审核"等不同权限角色
- **AI 洞察**: 集成 AI 分析，自动生成数据洞察报告
- **通知中心**: 系统消息推送（新评论、新用户、异常告警）

---

**计划版本**: v3.0
**创建日期**: 2026-02-06
**预计完成**: 8-12 个工作日
**负责人**: Dashboard Refactoring Team
